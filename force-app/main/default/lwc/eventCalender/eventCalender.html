<template>
    <lightning-card>
        <!--Month title-->
        <lightning-layout class="card-header">
            <lightning-layout-item padding="around-small" size="5">
                <p class="month-title">{monthName} {year}</p>
            </lightning-layout-item>
            <!--Case Number-->
            <lightning-layout-item padding="around-small" size="2">
                <lightning-badge label={caseNumber} class="slds-badge_lightest header-badge" icon-name="action:new_case"></lightning-badge>
            </lightning-layout-item>
            <!--Current User-->
            <lightning-layout-item padding="around-small" size="2">
                <lightning-badge label={currentUserName} class="slds-badge_lightest header-badge" icon-name="utility:user"></lightning-badge>
            </lightning-layout-item>
            <!--actions-->
            <lightning-layout-item padding="around-small" size="3">
                <div>
                    <lightning-button-icon icon-name="utility:change_owner" onclick={handleChangeOwner} variant="neutral"
                        class="seperate-btn"></lightning-button-icon>
                    <lightning-button-icon icon-name="utility:refresh" onclick={refresh} variant="neutral"
                        class="seperate-btn"></lightning-button-icon>
                    <lightning-button-icon icon-name="utility:chevronleft" onclick={handlePrev} variant="brand"></lightning-button-icon>
                    <lightning-button-icon icon-name="utility:chevronright" onclick={handleNext} class="slds-m-left_small"
                        variant="brand"></lightning-button-icon>
                </div>
            </lightning-layout-item>
        </lightning-layout>
        

        <!-- Calendar Grid -->
        <div class="slds-grid slds-wrap calendar-grid">
            <template for:each={weekdays} for:item="day">
                <div key={day} class="slds-col slds-size_1-of-7 slds-text-title_bold">{day}</div>
            </template>

            <template for:each={days} for:item="day">
                <div key={day.key} class="slds-col slds-size_1-of-7 calendar-cell">
                    <lightning-card title={day.date}>
                        <!--card body-->
                        <lightning-button-icon if:false={day.isPreviousMonthDate} title="Add Event" slot="actions" icon-name="utility:new" onclick={handleDayClick} data-date={day.date}></lightning-button-icon>
                        <div class="slds-p-horizontal_small">
                            <template for:each={day.initialEvents} for:item="e">
                                <span class="event" key={e.Id} title={e.Name} data-date={day.date} onclick={showAllEvents}><lightning-icon size="x-small" icon-name="standard:event"></lightning-icon>&nbsp;{e.title}</span>
                            </template>
                            <div class="view-all-btn">
                                <template if:true={day.multipleEvents}>
                                    <lightning-button label={day.evtCount} variant="base" data-date={day.date} onclick={showAllEvents}></lightning-button>
                                </template>
                            </div>
                        </div>
                    </lightning-card>
                </div>
            </template>
        </div>
    </lightning-card>

    <!--New Event Modal-->
    <template if:true={newEventModal}>
        <c-modal>
            <lightning-button-icon slot="closeModal" icon-name="utility:close" onclick={closeNewEventModal} variant="border-filled"></lightning-button-icon>
            <div slot="header">New Event</div>
            <div slot="body">

                <lightning-layout>
                    <lightning-layout-item padding="around-small" size="6">
                        <lightning-input type="datetime" label="Start date" class="evt-form-startdate" value={defultDateTime} ></lightning-input>
                    </lightning-layout-item>
                    <lightning-layout-item padding="around-small" size="6">
                       <lightning-input type="datetime" label="End date" class="evt-form-enddate" value={defultDateTime}></lightning-input>
                    </lightning-layout-item>
                </lightning-layout>

                <lightning-layout>
                    <lightning-layout-item padding="around-small" size="6">
                        <lightning-input label="Title" class="evt-form-title" maxlength="80"></lightning-input>
                    </lightning-layout-item>
                    <lightning-layout-item padding="around-small" size="6">
                        <lightning-input value={caseNumber} label="Case" disabled="true"></lightning-input>
                    </lightning-layout-item>
                </lightning-layout>

                <br/>
                <div class="evt-form-btn">
                    <lightning-button label="Save" onclick={save} variant="brand"></lightning-button>
                </div>
            </div>
        </c-modal>
    </template>

    <!--Edit Event Modal-->
    <template if:true={editEventModal}>
        <c-modal>
            <lightning-button-icon slot="closeModal" icon-name="utility:close" onclick={closeEditEventModal} variant="border-filled"></lightning-button-icon>
            <div slot="header">Edit Event</div>
            <div slot="body">

                <lightning-layout>
                    <lightning-layout-item padding="around-small" size="6">
                        <lightning-input type="datetime" label="Start date" class="evt-edit-startdate" value={editEventRecord.Event_Start_Date__c} ></lightning-input>
                    </lightning-layout-item>
                    <lightning-layout-item padding="around-small" size="6">
                        <lightning-input type="datetime" label="End date" class="evt-edit-enddate" value={editEventRecord.Event_End_Date__c}></lightning-input>
                    </lightning-layout-item>
                </lightning-layout>

                <lightning-layout>
                    <lightning-layout-item padding="around-small" size="6">
                        <lightning-input label="Title" class="evt-edit-title" maxlength="80" value={editEventRecord.Name}></lightning-input>
                    </lightning-layout-item>
                    <lightning-layout-item padding="around-small" size="6">
                        <lightning-combobox options={evtStatusValues} class="evt-edit-status" value={editEventRecord.Event_Status__c} label="Status"></lightning-combobox>
                    </lightning-layout-item>
                </lightning-layout>
                <br/>
                <div class="evt-form-btn">
                    <lightning-button label="Save" onclick={saveEditEvt} variant="brand"></lightning-button>
                </div>
            </div>
        </c-modal>
    </template>

    <!--Veiw All Event Modal-->
    <template if:true={allEventModal}>
        <c-modal>
            <lightning-button-icon slot="closeModal" icon-name="utility:close" onclick={closeAllEventModal} variant="border-filled"></lightning-button-icon>
            <div slot="header">View all events on <span class="display-date">{displaySelectedDate}</span></div>
            <div slot="body">
                <table>
                    <tbody>
                    <tr>
                        <th>Title</th>
                        <th>Case</th>
                        <th>Start</th>
                        <th>End</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                    <template for:each={dateEvents} for:item="evt">
                        <tr key={evt.Id} class={evt.Event_Status__c}>
                            <td><a onclick={navigateToRecord} data-id={evt.Id}>{evt.Name}</a></td>
                            <td><a onclick={navigateToRecord} data-id={evt.Case__c}>{evt.caseNumber}</a></td>
                            <td><lightning-formatted-date-time value={evt.Event_Start_Date__c} hour="2-digit" minute="2-digit"
                                    time-zone="IST"></lightning-formatted-date-time></td>
                            <td><lightning-formatted-date-time value={evt.Event_End_Date__c} hour="2-digit" minute="2-digit"
                                    time-zone="IST"></lightning-formatted-date-time></td>
                            <td>{evt.Event_Status__c}</td>
                            <td>
                                <div class="slds-p-around_medium lgc-bg">
                                    <lightning-button-icon icon-name="utility:edit" alternative-text="Edit"
                                        title="Edit" class="slds-m-right_x-small" data-btn="edit_event" data-eventid={evt.Id} onclick={handleEditEvent}></lightning-button-icon>
                                </div>
                            </td>
                        </tr>
                    </template>
                    </tbody>
                </table>
            </div>
        </c-modal>
    </template>
    <!--Change Owner Modal-->
    <template if:true={changeOwnerModal}>
        <c-modal>
            <lightning-button-icon slot="closeModal" icon-name="utility:close" onclick={closeChangeOwnerModal} variant="border-filled"></lightning-button-icon>
            <div slot="header">Change calender to different user</div>
            <div slot="body">
                <div>
                    <div style="margin-left:30rem;margin-top:2rem;height:200px">
                        <c-custom-lookup1 fields="Id,Name" additional-filter="AND IsActive = true" object-api-name="User"
                            searchable-field="Name" index='NA' field-name="NA" onlookupselected={handleUserChange} style="width: 500px;">
                        </c-custom-lookup1>
                    </div>
                </div>
            </div>
        </c-modal>
    </template>

    <!--Spinner-->
    <template if:true={loading}>
        <div>
            <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
        </div>
    </template>

</template>
